package posa

import (
	"math/big"

	"github.com/ethereum/go-ethereum/common"
)

//
// The Amazon Hardfork includes the following upgrades:
//   - KCC Staking Contract: Add a new method to migrate GoDao's KCS
//   - KCC Peg Token: Add a method to migrate stuck tokens
//   - Consensus: Reduce reorged blocks
//

type codeSetter interface {
	SetCode(addr common.Address, code []byte)
}

type AmazonPatch func(state codeSetter)

func GetAmazonPatches(chainID *big.Int) []AmazonPatch {

	chain := new(big.Int).Set(chainID)

	return []AmazonPatch{
		patchKCCStaking,
		func(state codeSetter) {
			patchKCCPegToken(chain, state)
		},
	}
}

// The patches for kcc staking:
//   - upgrade the staking contract code to commit "#3712140"
//
// This patch is the same for both mainnet and testnet
func patchKCCStaking(state codeSetter) {

	newCode := common.Hex2Bytes("")

	state.SetCode(IshikariValidatorsContractAddr, newCode)

}

// The patches for kcc peg token:
//   - upgrade the peg token contract code to commit "#e8f1655"
//
// The patch is not the same for mainnet and testnet
func patchKCCPegToken(chainID *big.Int, state codeSetter) {

	// The addresses of the peg token contracts (mainnet)
	mainnetContracts := []common.Address{
		common.HexToAddress("0x0039f574eE5cC39bdD162E9A88e3EB1f111bAF48"), // USDT
		common.HexToAddress("0x980a5AfEf3D17aD98635F6C5aebCBAedEd3c3430"), // USDC
		common.HexToAddress("0xfA93C12Cd345c658bc4644D1D4E1B9615952258C"), // BTCK
		common.HexToAddress("0xf55aF137A98607F7ED2eFEfA4cd2DfE70E4253b1"), // ETH
		common.HexToAddress("0x1B8e27ABA297466fc6765Ce55BD12A8E216759da"), // Polygon Matic
	}

	// The addresses of the peg token contracts (testnet)
	testnetContracts := []common.Address{
		common.HexToAddress("0x67f6a7BbE0da067A747C6b2bEdF8aBBF7D6f60dc"), // USDT
		common.HexToAddress("0xD6c7E27a598714c2226404Eb054e0c074C906Fc9"), // USDC
		common.HexToAddress("0xF8Cb9f1D136Ff4c883320b5B4fa80048b888F459"), // ETH
		common.HexToAddress("0xf57a7eE19a628e4d475b72d6c9DD847c50636e01"), // BTC
	}

	// The contracts to be patched
	targetContracts := mainnetContracts

	if chainID.Cmp(big.NewInt(322)) == 0 {
		targetContracts = testnetContracts
	}

	// appy the patch

	newCode := common.FromHex("0x608060405234801561001057600080fd5b50600436106101f05760003560e01c806379cc67901161010f578063a9059cbb116100a2578063dd62ed3e11610071578063dd62ed3e14610614578063e47d606014610642578063e63ab1e914610668578063f515e6f214610670576101f0565b8063a9059cbb14610597578063ca15c873146105c3578063d5391393146105e0578063d547741f146105e8576101f0565b806391d14854116100de57806391d148541461052f57806395d89b411461055b578063a217fddf14610563578063a457c2d71461056b576101f0565b806379cc67901461049657806379da7e59146104c25780638456cb59146104e85780639010d07c146104f0576101f0565b806336568abe1161018757806342966c681161015657806342966c68146104255780635c975abb1461044257806370a082311461044a5780637270024114610470576101f0565b806336568abe1461039957806339509351146103c55780633f4ba83a146103f157806340c10f19146103f9576101f0565b806323b872dd116101c357806323b872dd146102fa578063248a9ca3146103305780632f2ff15d1461034d578063313ce5671461037b576101f0565b806306fdde03146101f5578063095ea7b3146102725780631068361f146102b257806318160ddd146102f2575b600080fd5b6101fd610678565b6040805160208082528351818301528351919283929083019185019080838360005b8381101561023757818101518382015260200161021f565b50505050905090810190601f1680156102645780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b61029e6004803603604081101561028857600080fd5b506001600160a01b03813516906020013561070e565b604080519115158252519081900360200190f35b6102e0600480360360408110156102c857600080fd5b506001600160a01b038135811691602001351661072c565b60408051918252519081900360200190f35b6102e0610885565b61029e6004803603606081101561031057600080fd5b506001600160a01b0381358116916020810135909116906040013561088b565b6102e06004803603602081101561034657600080fd5b5035610912565b6103796004803603604081101561036357600080fd5b50803590602001356001600160a01b0316610927565b005b610383610993565b6040805160ff9092168252519081900360200190f35b610379600480360360408110156103af57600080fd5b50803590602001356001600160a01b031661099c565b61029e600480360360408110156103db57600080fd5b506001600160a01b0381351690602001356109fd565b610379610a4b565b6103796004803603604081101561040f57600080fd5b506001600160a01b038135169060200135610abc565b6103796004803603602081101561043b57600080fd5b5035610b2d565b61029e610b41565b6102e06004803603602081101561046057600080fd5b50356001600160a01b0316610b4a565b6103796004803603602081101561048657600080fd5b50356001600160a01b0316610b65565b610379600480360360408110156104ac57600080fd5b506001600160a01b038135169060200135610c18565b610379600480360360208110156104d857600080fd5b50356001600160a01b0316610c72565b610379610d22565b6105136004803603604081101561050657600080fd5b5080359060200135610d91565b604080516001600160a01b039092168252519081900360200190f35b61029e6004803603604081101561054557600080fd5b50803590602001356001600160a01b0316610db0565b6101fd610dc8565b6102e0610e29565b61029e6004803603604081101561058157600080fd5b506001600160a01b038135169060200135610e2e565b61029e600480360360408110156105ad57600080fd5b506001600160a01b038135169060200135610e96565b6102e0600480360360208110156105d957600080fd5b5035610eaa565b6102e0610ec1565b610379600480360360408110156105fe57600080fd5b50803590602001356001600160a01b0316610ee5565b6102e06004803603604081101561062a57600080fd5b506001600160a01b0381358116916020013516610f3e565b61029e6004803603602081101561065857600080fd5b50356001600160a01b0316610f69565b6102e0610f87565b6102e0610fab565b60038054604080516020601f60026000196101006001881615020190951694909404938401819004810282018101909252828152606093909290918301828280156107045780601f106106d957610100808354040283529160200191610704565b820191906000526020600020905b8154815290600101906020018083116106e757829003601f168201915b5050505050905090565b600061072261071b610fe4565b8484610fe8565b5060015b92915050565b60003373fa56aa4fc52623935c0e93a4d7ef79b9d5c951c8146107805760405162461bcd60e51b8152600401808060200182810382526021815260200180611b8b6021913960400191505060405180910390fd5b6000836001600160a01b03166370a08231306040518263ffffffff1660e01b815260040180826001600160a01b0316815260200191505060206040518083038186803b1580156107cf57600080fd5b505afa1580156107e3573d6000803e3d6000fd5b505050506040513d60208110156107f957600080fd5b50516040805163a9059cbb60e01b81526001600160a01b0386811660048301526024820184905291519293509086169163a9059cbb916044808201926020929091908290030181600087803b15801561085157600080fd5b505af1158015610865573d6000803e3d6000fd5b505050506040513d602081101561087b57600080fd5b5090949350505050565b60025490565b60006108988484846110d4565b610908846108a4610fe4565b61090385604051806060016040528060288152602001611bdc602891396001600160a01b038a166000908152600160205260408120906108e2610fe4565b6001600160a01b03168152602081019190915260400160002054919061122f565b610fe8565b5060019392505050565b60009081526006602052604090206002015490565b60008281526006602052604090206002015461094a90610945610fe4565b610db0565b6109855760405162461bcd60e51b815260040180806020018281038252602f815260200180611a85602f913960400191505060405180910390fd5b61098f82826112c6565b5050565b60055460ff1690565b6109a4610fe4565b6001600160a01b0316816001600160a01b0316146109f35760405162461bcd60e51b815260040180806020018281038252602f815260200180611d50602f913960400191505060405180910390fd5b61098f828261132f565b6000610722610a0a610fe4565b846109038560016000610a1b610fe4565b6001600160a01b03908116825260208083019390935260409182016000908120918c168152925290205490611398565b610a777f65d7a28e3265b37a6474929f336521b332c1681b933f6cb9f3376673440d862a610945610fe4565b610ab25760405162461bcd60e51b815260040180806020018281038252602f815260200180611af8602f913960400191505060405180910390fd5b610aba6113f2565b565b610ae87f9f2df0fed2c77648de5860a4cc508cd0818c85b8b8a1ab4ceeef8d981c8956a6610945610fe4565b610b235760405162461bcd60e51b815260040180806020018281038252602c815260200180611cd2602c913960400191505060405180910390fd5b61098f8282611492565b610b3e610b38610fe4565b82611582565b50565b60075460ff1690565b6001600160a01b031660009081526020819052604090205490565b610b917f98db8a220cd0f09badce9f22d0ba7e93edb3d404448cc3560d391ab096ad16e9610945610fe4565b610bcc5760405162461bcd60e51b815260040180806020018281038252603e815260200180611b4d603e913960400191505060405180910390fd5b6001600160a01b038116600081815260086020526040808220805460ff19166001179055517f7fd26be6fc92aff63f1f4409b2b2ddeb272a888031d7f55ec830485ec61941869190a250565b6000610c4f82604051806060016040528060248152602001611c0460249139610c4886610c43610fe4565b610f3e565b919061122f565b9050610c6383610c5d610fe4565b83610fe8565b610c6d8383611582565b505050565b610c9e7f98db8a220cd0f09badce9f22d0ba7e93edb3d404448cc3560d391ab096ad16e9610945610fe4565b610cd95760405162461bcd60e51b8152600401808060200182810382526040815260200180611c6e6040913960400191505060405180910390fd5b6001600160a01b038116600081815260086020526040808220805460ff19169055517fcdd762171e068b4051cab8b4813f8783756ae1a3d4d379ec5c82d05650c54f1d9190a250565b610d4e7f65d7a28e3265b37a6474929f336521b332c1681b933f6cb9f3376673440d862a610945610fe4565b610d895760405162461bcd60e51b815260040180806020018281038252602d815260200180611cfe602d913960400191505060405180910390fd5b610aba61167e565b6000828152600660205260408120610da99083611701565b9392505050565b6000828152600660205260408120610da9908361170d565b60048054604080516020601f60026000196101006001881615020190951694909404938401819004810282018101909252828152606093909290918301828280156107045780601f106106d957610100808354040283529160200191610704565b600081565b6000610722610e3b610fe4565b8461090385604051806060016040528060258152602001611d2b6025913960016000610e65610fe4565b6001600160a01b03908116825260208083019390935260409182016000908120918d1681529252902054919061122f565b6000610722610ea3610fe4565b84846110d4565b600081815260066020526040812061072690611722565b7f9f2df0fed2c77648de5860a4cc508cd0818c85b8b8a1ab4ceeef8d981c8956a681565b600082815260066020526040902060020154610f0390610945610fe4565b6109f35760405162461bcd60e51b8152600401808060200182810382526030815260200180611bac6030913960400191505060405180910390fd5b6001600160a01b03918216600090815260016020908152604080832093909416825291909152205490565b6001600160a01b031660009081526008602052604090205460ff1690565b7f65d7a28e3265b37a6474929f336521b332c1681b933f6cb9f3376673440d862a81565b7f98db8a220cd0f09badce9f22d0ba7e93edb3d404448cc3560d391ab096ad16e981565b6000610da9836001600160a01b03841661172d565b3390565b6001600160a01b03831661102d5760405162461bcd60e51b8152600401808060200182810382526024815260200180611cae6024913960400191505060405180910390fd5b6001600160a01b0382166110725760405162461bcd60e51b8152600401808060200182810382526022815260200180611ad66022913960400191505060405180910390fd5b6001600160a01b03808416600081815260016020908152604080832094871680845294825291829020859055815185815291517f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b9259281900390910190a3505050565b6001600160a01b0383166111195760405162461bcd60e51b8152600401808060200182810382526025815260200180611c496025913960400191505060405180910390fd5b6001600160a01b03821661115e5760405162461bcd60e51b8152600401808060200182810382526023815260200180611a626023913960400191505060405180910390fd5b611169838383611777565b6111a681604051806060016040528060268152602001611b27602691396001600160a01b038616600090815260208190526040902054919061122f565b6001600160a01b0380851660009081526020819052604080822093909355908416815220546111d59082611398565b6001600160a01b038084166000818152602081815260409182902094909455805185815290519193928716927fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef92918290030190a3505050565b600081848411156112be5760405162461bcd60e51b81526004018080602001828103825283818151815260200191508051906020019080838360005b8381101561128357818101518382015260200161126b565b50505050905090810190601f1680156112b05780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b505050900390565b60008281526006602052604090206112de9082610fcf565b1561098f576112eb610fe4565b6001600160a01b0316816001600160a01b0316837f2f8788117e7eff1d82e926ec794901d17c78024a50270940304540a733656f0d60405160405180910390a45050565b60008281526006602052604090206113479082611838565b1561098f57611354610fe4565b6001600160a01b0316816001600160a01b0316837ff6391f5c32d9c69d2a47ea670b442974b53935d1edc7fd64eb21e047a839171b60405160405180910390a45050565b600082820183811015610da9576040805162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604482015290519081900360640190fd5b6113fa610b41565b611442576040805162461bcd60e51b815260206004820152601460248201527314185d5cd8589b194e881b9bdd081c185d5cd95960621b604482015290519081900360640190fd5b6007805460ff191690557f5db9ee0a495bf2e6ff9c91a7834c1ba4fdd244a5e8aa4e537bd38aeae4b073aa611475610fe4565b604080516001600160a01b039092168252519081900360200190a1565b6001600160a01b0382166114ed576040805162461bcd60e51b815260206004820152601f60248201527f45524332303a206d696e7420746f20746865207a65726f206164647265737300604482015290519081900360640190fd5b6114f960008383611777565b6002546115069082611398565b6002556001600160a01b03821660009081526020819052604090205461152c9082611398565b6001600160a01b0383166000818152602081815260408083209490945583518581529351929391927fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9281900390910190a35050565b6001600160a01b0382166115c75760405162461bcd60e51b8152600401808060200182810382526021815260200180611c286021913960400191505060405180910390fd5b6115d382600083611777565b61161081604051806060016040528060228152602001611ab4602291396001600160a01b038516600090815260208190526040902054919061122f565b6001600160a01b038316600090815260208190526040902055600254611636908261184d565b6002556040805182815290516000916001600160a01b038516917fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9181900360200190a35050565b611686610b41565b156116cb576040805162461bcd60e51b815260206004820152601060248201526f14185d5cd8589b194e881c185d5cd95960821b604482015290519081900360640190fd5b6007805460ff191660011790557f62e78cea01bee320cd4e420270b5ea74000d11b0c9f74754ebdbfc544b05a258611475610fe4565b6000610da983836118aa565b6000610da9836001600160a01b03841661190e565b600061072682611926565b6000611739838361190e565b61176f57508154600181810184556000848152602080822090930184905584548482528286019093526040902091909155610726565b506000610726565b61178283838361192a565b61178b83610f69565b156117dd576040805162461bcd60e51b815260206004820152601d60248201527f4552433230506567546f6b656e3a20696e76616c69642073656e646572000000604482015290519081900360640190fd5b6117e682610f69565b15610c6d576040805162461bcd60e51b815260206004820181905260248201527f4552433230506567546f6b656e3a20696e76616c696420726563697069656e74604482015290519081900360640190fd5b6000610da9836001600160a01b038416611979565b6000828211156118a4576040805162461bcd60e51b815260206004820152601e60248201527f536166654d6174683a207375627472616374696f6e206f766572666c6f770000604482015290519081900360640190fd5b50900390565b815460009082106118ec5760405162461bcd60e51b8152600401808060200182810382526022815260200180611a406022913960400191505060405180910390fd5b8260000182815481106118fb57fe5b9060005260206000200154905092915050565b60009081526001919091016020526040902054151590565b5490565b611935838383610c6d565b61193d610b41565b15610c6d5760405162461bcd60e51b815260040180806020018281038252602a815260200180611d7f602a913960400191505060405180910390fd5b60008181526001830160205260408120548015611a3557835460001980830191908101906000908790839081106119ac57fe5b90600052602060002001549050808760000184815481106119c957fe5b6000918252602080832090910192909255828152600189810190925260409020908401905586548790806119f957fe5b60019003818190600052602060002001600090559055866001016000878152602001908152602001600020600090556001945050505050610726565b600091505061072656fe456e756d657261626c655365743a20696e646578206f7574206f6620626f756e647345524332303a207472616e7366657220746f20746865207a65726f2061646472657373416363657373436f6e74726f6c3a2073656e646572206d75737420626520616e2061646d696e20746f206772616e7445524332303a206275726e20616d6f756e7420657863656564732062616c616e636545524332303a20617070726f766520746f20746865207a65726f20616464726573734552433230506567546f6b656e3a206d75737420686176652070617573657220726f6c6520746f20756e706175736545524332303a207472616e7366657220616d6f756e7420657863656564732062616c616e63654552433230506567546f6b656e3a206d757374206861766520626c61636b6c697374657220726f6c6520746f207365742074686520626c61636b6c6973744552433230506567546f6b656e3a206f6e6c79206d69677261746f7220726f6c65416363657373436f6e74726f6c3a2073656e646572206d75737420626520616e2061646d696e20746f207265766f6b6545524332303a207472616e7366657220616d6f756e74206578636565647320616c6c6f77616e636545524332303a206275726e20616d6f756e74206578636565647320616c6c6f77616e636545524332303a206275726e2066726f6d20746865207a65726f206164647265737345524332303a207472616e736665722066726f6d20746865207a65726f20616464726573734552433230506567546f6b656e3a206d757374206861766520626c61636b6c697374657220726f6c6520746f20756e7365742074686520626c61636b6c69737445524332303a20617070726f76652066726f6d20746865207a65726f20616464726573734552433230506567546f6b656e3a206d7573742068617665206d696e74657220726f6c6520746f206d696e744552433230506567546f6b656e3a206d75737420686176652070617573657220726f6c6520746f20706175736545524332303a2064656372656173656420616c6c6f77616e63652062656c6f77207a65726f416363657373436f6e74726f6c3a2063616e206f6e6c792072656e6f756e636520726f6c657320666f722073656c6645524332305061757361626c653a20746f6b656e207472616e73666572207768696c6520706175736564a264697066735822122019d4b78b45cee9c4431c386a85bcd4901a527860dafbf39bd68c77dbaed87e1f64736f6c634300060c0033")

	for _, addr := range targetContracts {
		state.SetCode(addr, newCode)
	}

}
